<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        th, td { text-align: center; vertical-align: middle; }
        .btn-hover { color: #0d6efd; transition: all 0.2s; text-decoration: none; }
        .btn-hover:hover { background-color: #0d6efd; color: white; }

        .btn-turquoise {
            background-color: #20c997;
            border-color: #20c997;
            color: #fff;
        }
        .btn-turquoise:hover,
        .btn-turquoise:focus {
            background-color: #17a589;
            border-color: #17a589;
            color: #fff;
            box-shadow: none;
        }

        .field-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 250px;
            margin-bottom: 10px;
        }
        .field-block label {
            text-align: center;
            font-weight: 500;
            margin-bottom: 6px;
            width: 100%;
        }
        .field-block input,
        .field-block select { width: 100%; }
        select.form-control { min-height: 38px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-text text-white">
            <b id="current-user-email">Loading...</b> with roles:
            <span id="current-user-roles">Loading...</span>
        </span>
        <button id="logout-btn" type="button" class="bg-transparent border-0 ms-auto" style="color: rgb(154, 154, 143);">
            Logout
        </button>
    </div>
</nav>

<div class="container-fluid mt-3">
    <div class="row">
        <!-- Left Menu -->
        <div class="col-2 bg-light vh-100 p-0">
            <div class="list-group">
                <a href="/admin.html" class="list-group-item list-group-item-action btn-hover border-0 w-100 text-start active">Admin</a>
                <a href="/user.html" class="list-group-item list-group-item-action btn-hover border-0 w-100 text-start">User</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-10">
            <h2 class="mt-3">Admin Panel</h2>

            <!-- Tabs -->
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#users-table-tab">Users Table</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#new-user-tab">New User</a>
                </li>
            </ul>

            <div class="tab-content mt-3">

                <!-- Users Table -->
                <div class="tab-pane fade show active" id="users-table-tab">
                    <div class="card">
                        <div class="card-header">All Users</div>
                        <div class="card-body">
                            <table class="table table-hover" id="users-table">
                                <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Age</th>
                                    <th>Email</th>
                                    <th>Roles</th>
                                    <th>Edit</th>
                                    <th>Delete</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- New User Form -->
                <div class="tab-pane fade" id="new-user-tab">
                    <div class="card">
                        <div class="card-header">Add New User</div>
                        <div class="card-body d-flex justify-content-center">
                            <form id="new-user-form" class="d-flex flex-column align-items-center" style="width:100%; max-width:400px;">
                                <div class="field-block">
                                    <label>First Name</label>
                                    <input type="text" name="firstName" class="form-control">
                                </div>
                                <div class="field-block">
                                    <label>Last Name</label>
                                    <input type="text" name="lastName" class="form-control">
                                </div>
                                <div class="field-block">
                                    <label>Age</label>
                                    <input type="number" name="age" class="form-control">
                                </div>
                                <div class="field-block">
                                    <label>Email</label>
                                    <input type="email" name="email" class="form-control">
                                </div>
                                <div class="field-block">
                                    <label>Password</label>
                                    <input type="password" name="password" class="form-control">
                                </div>
                                <div class="field-block">
                                    <label>Roles</label>
                                    <select name="roleIds" class="form-control" multiple style="max-height:120px; overflow-y:auto;"></select>
                                    <small class="text-muted d-block text-center mt-1">Hold Ctrl (Cmd) to select multiple roles</small>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-success">Add New User</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Edit/Delete Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="max-width:500px; padding:20px;">
            <form id="modal-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column align-items-center">
                    <input type="hidden" name="id">
                    <div class="field-block">
                        <label>First Name</label>
                        <input type="text" name="firstName" class="form-control">
                    </div>
                    <div class="field-block">
                        <label>Last Name</label>
                        <input type="text" name="lastName" class="form-control">
                    </div>
                    <div class="field-block">
                        <label>Age</label>
                        <input type="number" name="age" class="form-control">
                    </div>
                    <div class="field-block">
                        <label>Email</label>
                        <input type="email" name="email" class="form-control">
                    </div>
                    <div class="field-block">
                        <label>Password</label>
                        <input type="password" name="password" class="form-control" placeholder="Leave empty to keep current">
                    </div>
                    <div class="field-block">
                        <label>Roles</label>
                        <select name="roleIds" class="form-control" multiple style="max-height:120px; overflow-y:auto;"></select>
                    </div>
                </div>
                <div class="modal-footer justify-content-end">
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn" id="modal-submit-btn"></button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    const modalTitle = document.getElementById('modal-title');
    const modalSubmit = document.getElementById('modal-submit-btn');
    const modalForm = document.getElementById('modal-form');

    // ---------------- Current User ----------------
    fetch('/api/user/me')
        .then(res => res.json())
        .then(user => {
            document.getElementById('current-user-email').textContent = user.email;
            document.getElementById('current-user-roles').textContent = Array.from(user.rolesNames).join(' ');
        });

    // ---------------- Roles List ----------------
    let allRoles = [];
    fetch('/api/admin/users/roles')
        .then(res => res.json())
        .then(roles => {
            allRoles = roles;
            document.querySelectorAll('select[name="roleIds"]').forEach(sel => {
                sel.innerHTML = '';
                roles.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = r.name.replace('ROLE_', '');
                    sel.appendChild(opt);
                });
            });
        });

    // ---------------- Users Table ----------------
    function loadUsers() {
        fetch('/api/admin/users')
            .then(res => res.json())
            .then(users => {
                const tbody = document.querySelector('#users-table tbody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.firstName}</td>
                        <td>${user.lastName}</td>
                        <td>${user.age != null ? user.age : '-'}</td>
                        <td>${user.email}</td>
                        <td>${Array.from(user.rolesNames).join(' ')}</td>
                        <td><button class="btn btn-turquoise btn-sm edit-btn" data-id="${user.id}">Edit</button></td>
                        <td><button class="btn btn-danger btn-sm delete-btn" data-id="${user.id}">Delete</button></td>
                    `;
                    tbody.appendChild(tr);
                });
                attachButtons();
            });
    }

    // ---------------- Buttons Handlers ----------------
    function attachButtons() {
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.onclick = () => openModal('edit', btn.dataset.id);
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = () => openModal('delete', btn.dataset.id);
        });
    }

    function openModal(mode, userId) {
        fetch(`/api/admin/users/${userId}`)
            .then(res => res.json())
            .then(user => {
                modalForm.reset();
                modalForm.id.value = user.id;
                modalForm.firstName.value = user.firstName;
                modalForm.lastName.value = user.lastName;
                modalForm.age.value = user.age != null ? user.age : '';
                modalForm.email.value = user.email;
                modalForm.password.value = '';
                const roleSelect = modalForm.roleIds;
                Array.from(roleSelect.options).forEach(opt => {
                    opt.selected = user.rolesNames.includes(opt.text) || user.rolesNames.includes('ROLE_' + opt.text);
                    opt.disabled = false;
                });

                if (mode === 'edit') {
                    modalTitle.textContent = 'Edit User';
                    modalSubmit.textContent = 'Save';
                    modalSubmit.className = 'btn btn-primary';
                } else {
                    modalTitle.textContent = 'Delete User';
                    modalSubmit.textContent = 'Delete';
                    modalSubmit.className = 'btn btn-danger';
                    Array.from(roleSelect.options).forEach(opt => opt.disabled = true);
                    modalForm.firstName.disabled = true;
                    modalForm.lastName.disabled = true;
                    modalForm.age.disabled = true;
                    modalForm.email.disabled = true;
                    modalForm.password.disabled = true;
                }
                userModal.show();
            });
    }

    // ---------------- Modal Submit ----------------
    modalForm.onsubmit = e => {
        e.preventDefault();
        const id = modalForm.id.value;
        const payload = {
            firstName: modalForm.firstName.value,
            lastName: modalForm.lastName.value,
            age: modalForm.age.value ? Number(modalForm.age.value) : null,
            email: modalForm.email.value,
            password: modalForm.password.value || null,
            roleIds: Array.from(modalForm.roleIds.selectedOptions).map(o => Number(o.value))
        };
        if (modalSubmit.textContent === 'Save') {
            fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            }).then(() => loadUsers());
        } else {
            fetch(`/api/admin/users/${id}`, { method: 'DELETE' })
                .then(() => loadUsers());
        }
        userModal.hide();
    };

    // ---------------- New User Submit ----------------
    document.getElementById('new-user-form').onsubmit = e => {
        e.preventDefault();
        const form = e.target;
        const payload = {
            firstName: form.firstName.value,
            lastName: form.lastName.value,
            age: form.age.value ? Number(form.age.value) : null,
            email: form.email.value,
            password: form.password.value || null,
            roleIds: Array.from(form.roleIds.selectedOptions).map(o => Number(o.value))
        };
        fetch('/api/admin/users', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(() => {
                loadUsers();
                form.reset();
            });
    };

    // ---------------- Logout ----------------
    document.getElementById('logout-btn').onclick = () => {
        fetch('/logout', { method: 'POST' }).then(() => window.location.href = '/login.html');
    };

    // ---------------- Initial Load ----------------
    loadUsers();
</script>
</body>
</html>